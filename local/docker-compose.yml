services:
  minecraft:
    image: "itzg/minecraft-server:java21"
    container_name: "minecraft"
    ports:
      - "25565:25565"
    env_file:
      - ./config-overrides/minecraft-public.env  # Load first
      - ./config-overrides/minecraft-private.env # Load second (Can include sensitive info)
    environment:
      EULA: "TRUE"
      TYPE: "AUTO_CURSEFORGE"
      CF_API_KEY: "${CF_API_KEY}"
      CF_SLUG: "${MODPACK_SLUG}"
      MEMORY: "10G"
      RCON_PORT: 25575
      RCON_PASSWORD: "${RCON_PASSWORD}"
      MODS: "https://www.curseforge.com/minecraft/mc-mods/serverpauser"

      JVM_OPTS: >
        -XX:+UseG1GC
        -XX:+ParallelRefProcEnabled
        -XX:MaxGCPauseMillis=200
        -XX:+UnlockExperimentalVMOptions
        -XX:+DisableExplicitGC
        -XX:+AlwaysPreTouch
        -XX:G1NewSizePercent=30
        -XX:G1MaxNewSizePercent=40
        -XX:G1HeapRegionSize=8M
        -XX:G1ReservePercent=20
        -XX:G1HeapWastePercent=5
        -XX:G1MixedGCCountTarget=4
        -XX:InitiatingHeapOccupancyPercent=15
        -XX:G1MixedGCLiveThresholdPercent=90
        -XX:G1RSetUpdatingPauseTimePercent=5
        -XX:SurvivorRatio=32
        -XX:+PerfDisableSharedMem
        -XX:MaxTenuringThreshold=1

    volumes:
      - "./instances/${DATA_FOLDER}:/data"
      - "./config-overrides/serverpauser.toml:/data/config/serverpauser.toml"

  backup:
      image: itzg/mc-backup
      container_name: "minecraft-backup"
      environment:
        RCON_HOST: minecraft
        RCON_PORT: 25575
        RCON_PASSWORD: "${RCON_PASSWORD}"
        BACKUP_INTERVAL: "1h"
        PRUNE_BACKUPS_DAYS: 7
        BACKUP_METHOD: restic
        RESTIC_PASSWORD: "${RESTIC_PASSWORD}"
        RESTIC_REPOSITORY: "/backups"
      volumes:
        - "./instances/${DATA_FOLDER}:/data"
        - "./backups/${DATA_FOLDER}:/backups/"

  frpc:
    image: snowdreamtech/frpc
    container_name: frpc
    restart: always
    volumes:
      - ./frpc.toml:/etc/frp/frpc.toml
    network_mode: "host"